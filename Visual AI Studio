<!DOCTYPE html>
<html lang="en">
<head>
<script>
(function(){
  function setStatus(msg){
    var f = function(){
      try{
        var el = document.getElementById('jsReady');
        if (el) el.textContent = msg;
      }catch(_){}
    };
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', f);
    } else { f(); }
  }
  // Early heartbeat: if you see 'JS: init‚Ä¶' the page script is running.
  setStatus('JS: init‚Ä¶');
  // Error hooks
  window.addEventListener('error', function(e){
    setStatus('JS: error');
    try{ console.error('[VAS][error]', e.message, e.error); }catch(_){}
  });
  window.addEventListener('unhandledrejection', function(e){
    setStatus('JS: error');
    try{ console.error('[VAS][unhandled]', e.reason); }catch(_){}
  });
  try{ console.log('[VAS] early diagnostics ready'); }catch(_){}
})();
</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Visual AI Studio ‚Äì EPIC v1.2.1</title>
  <meta name="description" content="Plan, generate, assemble, and export your first AI-driven video‚Äîend to end in the browser. Now with pacing tools, beat captions, safe-area guides, watermark, and experimental MP4."/>
  <meta name="theme-color" content="#7c3aed">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#7c3aed; --primary-600:#6d28d9; --accent:#10b981; --bg:#0b1220; --card:#0f172a;
      --text:#e5e7eb; --muted:#9aa3b2; --border:#1f2937; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 20% -10%, #1f2937 0%, transparent 60%), linear-gradient(180deg,#0b1220,#0b1220 60%,#0a0f1a);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
    h1,h2,h3{font-family:Poppins,Inter,sans-serif}
    a{color:#a78bfa}
    .header{position:sticky;top:0;z-index:40;background:rgba(11,18,32,.75);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .nav{max-width:1200px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center;color:#c4b5fd;font-weight:800}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#111827;color:#e5e7eb;font-weight:600;cursor:pointer}
    .btn:hover{border-color:#334155}
    .btn-primary{background:var(--primary);border-color:var(--primary);color:white}
    .btn-danger{background:#7f1d1d;border-color:#991b1b}
    .wrap{max-width:1200px;margin:0 auto;padding:26px 20px}
    .hero{display:grid;grid-template-columns:1.15fr .85fr;gap:28px;align-items:center;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px;background:linear-gradient(135deg, rgba(124,58,237,.15), rgba(59,130,246,.08))}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#0a1020;border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:#cbd5e1}
    .tabs{margin-top:22px}
    .tab-list{display:flex;gap:8px;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--border);background:#0f172a;padding:10px 14px;border-radius:10px;font-weight:600;color:#cbd5e1;cursor:pointer}
    .tab-btn.active{background:var(--primary);border-color:var(--primary);color:#fff}
    .tab-panel{display:none;margin-top:16px}
    .tab-panel.active{display:block}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .col-12{grid-column:span 12} .col-8{grid-column:span 8} .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3}
    input[type], textarea, select{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:10px;background:#0a1020;color:#e5e7eb}
    textarea{min-height:110px;resize:vertical}
    .small{font-size:.9rem;color:#9aa3b2}
    .out{background:#0a1020;border:1px solid var(--border);border-radius:12px;padding:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .progress{height:8px;background:#111827;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .progress>div{height:100%;background:linear-gradient(90deg,#10b981,#7c3aed);width:14.2%;transition:width .35s ease}
    .asset-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .asset{border:1px dashed #334155;border-radius:12px;padding:10px}
    canvas{background:#000;border-radius:12px;border:1px solid var(--border)}
    .timeline{display:flex;gap:8px;overflow:auto;padding:6px;border:1px solid var(--border);border-radius:10px;background:#0a1020}
    .clip{min-width:120px;border-radius:8px;padding:6px;background:#1f2937;border:1px solid #334155;color:#cbd5e1}
    .clip img{width:100%;height:70px;object-fit:cover;border-radius:6px;border:1px solid #334155}
    .notice{background:#05211a;border:1px solid #0b3b2a;color:#a7f3d0;border-radius:10px;padding:10px}
    .warn{background:#24110f;border:1px solid #7f1d1d;color:#fecaca;border-radius:10px;padding:10px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    @media (max-width:980px){.hero{grid-template-columns:1fr}.col-8{grid-column:span 12}.col-6{grid-column:span 12}.col-4{grid-column:span 12}}
  </style>
</head>
<body>
<header class="header">
  <nav class="nav">
    <div class="brand">üé¨ Visual AI Studio</div>
    <div class="actions">
      <button id="saveBtn" class="btn">üíæ Save</button>
      <button id="importBtn" class="btn">üì• Import</button>
      <button id="exportJsonBtn" class="btn">üßæ Export JSON</button>
      <button id="bundleBtn" class="btn btn-primary">‚¨áÔ∏è Export Bundle (.zip)</button>
      <button id="resetBtn" class="btn btn-danger">‚ôªÔ∏è Reset All</button>
      <span id="saveIndicator" class="small">Unsaved</span>
      <span id="jsReady" class="small">JS: loading‚Ä¶</span>
    </div>
  </nav>
</header>

<main class="wrap" data-save-scope>
  <!-- ... (unchanged HTML content above tabs and main steps) ... -->

  <section class="tabs" aria-label="Studio steps">
    <div class="tab-list" role="tablist">
      <button class="tab-btn active" role="tab" aria-controls="s1">1) Plan & Script</button>
      <button class="tab-btn" role="tab" aria-controls="s2" aria-disabled="true">2) Shot List & Prompts</button>
      <button class="tab-btn" role="tab" aria-controls="s3" aria-disabled="true">3) Assets & Timeline</button>
      <button class="tab-btn" role="tab" aria-controls="s4" aria-disabled="true">4) Captions & Branding</button>
      <button class="tab-btn" role="tab" aria-controls="s5" aria-disabled="true">5) Render & Export</button>
    </div>
    <!-- ... (rest of tab-panel HTML unchanged) ... -->
  </section>

  <!-- ... (rest of HTML unchanged) ... -->

<input id="importFile" type="file" accept="application/json" style="display:none"/>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js" crossorigin="anonymous"></script>
<script>
// ---------- helpers ----------
const $=(s,c=document)=>c.querySelector(s); const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const KEY='visual_ai_studio_epic_v1_2_1';
// ... (unchanged helper and state code) ...

// ---------- tabs ----------
function updateProgress(step){
  const fill=$('#progressFill'); if(fill){ fill.style.width=(step*20)+'%'; }
  const txt=$('#progressText'); const names=['Plan & Script','Shot List & Prompts','Assets & Timeline','Captions & Branding','Render & Export'];
  if(txt) txt.innerHTML = '<strong>Step '+step+'/5:</strong> '+names[step-1];
  const bar=$('[role="progressbar"]'); if(bar) bar.setAttribute('aria-valuenow', String(step));
}
function currentStep(){ const idx=$$('[role="tab"]').findIndex(t=>t.classList.contains('active')); return idx>=0?idx+1:1; }
function gotoStep(step){
  const tabs=$$('[role="tab"]'); const panels=$$('.tab-panel');
  tabs.forEach((t,i)=>{ const on=i===step-1; t.classList.toggle('active',on); t.setAttribute('aria-selected',on?'true':'false'); });
  panels.forEach((p,i)=>{ p.classList.toggle('active', i===step-1); });
  updateProgress(step);
}
function setStepEnabled(step, enabled){
  const tabs=$$('[role="tab"]'); if(tabs[step-1]) tabs[step-1].setAttribute('aria-disabled', enabled?'false':'true');
  const btnIds={1:'toS2',2:'toS3',4:'toS5'};
  const btn=$('#'+btnIds[step]); if(btn) btn.disabled=!enabled;
}

// ---------- Step 1: shot list + starters ----------
// ... (unchanged) ...

// ---------- Step 2: scenes + pacing ----------
// ... (unchanged) ...

// ---------- Step 3: assets & timeline ----------
function renderAssets(){
  const list=$('#assetList'); list.innerHTML='';
  assets.forEach(a=>{
    const div=document.createElement('div'); div.className='asset';
    div.innerHTML=`<div class="small" style="opacity:.8">${a.type.toUpperCase()} ‚Ä¢ ${a.name}</div>
      <video ${a.type==='video'?'':'style="display:none"'} src="${a.url}" muted playsinline width="100%"></video>
      <img ${a.type==='image'?'':'style="display:none"'} src="${a.url}" style="width:100%;border-radius:8px;opacity:.9"/>
      <div class="toolbar" style="margin-top:6px">
        <button class="btn" data-add>‚ûï Add to Timeline</button>
        <button class="btn" data-rm>üóë Remove</button>
      </div>`;
    div.querySelector('[data-add]').addEventListener('click',()=>{
      const scene = scenes.find(s=>!s.assetId);
      if(scene){ scene.assetId=a.id; renderScenes(); }
      renderTimeline(); markSaved();
    });
    div.querySelector('[data-rm]').addEventListener('click',()=>{
      const removed = assets.find(x=>x.id===a.id);
      if (removed && removed.url.startsWith('blob:')) URL.revokeObjectURL(removed.url);
      assets=assets.filter(x=>x.id!==a.id); scenes.forEach(s=>{ if(s.assetId===a.id) s.assetId=null; });
      renderAssets(); renderScenes(); renderTimeline(); markSaved();
    });
    list.appendChild(div);
  });
}
function renderTimeline(){
  const tl=$('#timeline'); tl.innerHTML='';
  scenes.forEach((s,idx)=>{
    const clip=document.createElement('div'); clip.className='clip';
    const asset = assets.find(a=>a.id===s.assetId);
    clip.innerHTML = asset
      ? (asset.type==='image'
          ? `<img src="${asset.url}" alt="">`
          : `<span style="display:inline-block;width:100px;height:70px;background:#333;color:#fff;text-align:center;line-height:70px;border-radius:6px;border:1px solid #334155;">üé¨</span>`)
      : '';
    clip.innerHTML += `<div class="small" style="margin-top:4px"><strong>S${idx+1}</strong> ‚Ä¢ ${s.duration||3}s ${asset?('‚Ä¢ '+asset.type):''}</div>`;
    tl.appendChild(clip);
  });
  $('#toS4').disabled = scenes.every(s=>!s.assetId);
}

// uploads
// ... (unchanged asset upload code) ...

// preview (canvas)
// ... (unchanged preview code) ...

// ---------- captions (beat sync) ----------
// ... (unchanged) ...

// ---------- Step 5: render ----------
// ... (unchanged) ...

// ---------- FFmpeg.wasm (lazy) ----------
// ... (unchanged) ...

// ---------- captions helpers ----------
// ... (unchanged) ...

// ---------- watermark ----------
// ... (unchanged) ...

// ---------- header actions ----------
// ... (unchanged) ...

// ---------- wiring ----------
document.addEventListener('click', (e)=>{
  const tab=e.target.closest('[role="tab"]'); 
  if(tab && tab.getAttribute('aria-disabled')!=='true'){ 
    const tabs=$$('[role="tab"]'); gotoStep(tabs.indexOf(tab)+1); 
  }
});
// ... (rest of wiring unchanged) ...

function renderOnLoad(){
  if(($('#shotlist').value||'').trim()) setStepEnabled(2,true);
  if(scenes.length) setStepEnabled(3,true);
  if(assets.some(a=>a.type==='video'||a.type==='image')) setStepEnabled(4,true);
  if($('#captions').value.trim() || $('#brandTopText').value.trim() || $('#brandBottomText').value.trim()) setStepEnabled(5,true);
}

// init
function init(){
  $('#jsReady').textContent='JS: ready';
  autosaveWire(); restore(); renderOnLoad();
}
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
</script>
</body>
</html>
