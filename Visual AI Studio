<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Visual AI Studio â€“ EPIC v1.2.1</title>
  <meta name="description" content="Plan, generate, assemble, and export short-form videos with AI assist: scripts, shot lists, scenes, captions, safe-area guides, watermark, and experimental MP4."/>
  <meta name="theme-color" content="#7c3aed">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#7c3aed; --primary-600:#6d28d9; --accent:#10b981; --bg:#0b1220; --card:#0f172a;
      --border:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --text-dim:#cbd5e1;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 60% -10%, rgba(124,58,237,.18), transparent), linear-gradient(180deg,#0b1220,#0b1220 300px,#0b1220); color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
    h1,h2,h3{font-family:Poppins,Inter,sans-serif}
    a{color:#a78bfa;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .header{position:sticky;top:0;z-index:40;background:rgba(11,18,32,.65);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .nav{max-width:1200px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center;color:#c4b5fd;font-weight:800}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#111827;color:#e5e7eb;font-weight:600;cursor:pointer}
    .btn:hover{border-color:#334155}
    .btn-primary{background:var(--primary);border-color:var(--primary);color:white}
    .btn-danger{background:#7f1d1d;border-color:#7f1d1d}
    .small{font-size:12px;opacity:.8}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#111827;border:1px solid var(--border);color:#cbd5e1;font-weight:600}
    .card{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid var(--border);border-radius:14px;padding:14px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col-8{grid-column:span 8}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
    textarea, input, select{width:100%;background:#0b1220;border:1px solid var(--border);color:#e5e7eb;border-radius:10px;padding:10px}
    label{display:block;font-weight:600;margin:10px 0 6px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0f172a;color:#cbd5e1;cursor:pointer}
    .tab.active{background:var(--primary);border-color:var(--primary);color:white}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .progress{height:6px;background:#0f172a;border:1px solid var(--border);border-radius:6px;overflow:hidden}
    .progress>div{height:100%;background:linear-gradient(90deg,#10b981,#7c3aed);width:14.2%;transition:width .35s ease}
    .asset-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .asset{border:1px dashed #334155;border-radius:12px;padding:10px}
    canvas{background:#000;border-radius:12px;border:1px solid var(--border)}
    .timeline{display:flex;gap:8px;overflow:auto;padding:6px;border:1px solid var(--border);border-radius:10px;background:#0a1020}
    .clip{min-width:120px;border-radius:8px;padding:6px;background:#1f2937;border:1px solid #334155;color:#cbd5e1}
    .clip img{width:100%;height:70px;object-fit:cover;border-radius:6px;border:1px solid #334155}
    .notice{background:#05211a;border:1px solid #0b3b2a;color:#a7f3d0;border-radius:10px;padding:10px}
    .warn{background:#24110f;border:1px solid #7f1d1d;color:#fecaca;border-radius:10px;padding:10px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    @media (max-width:980px){.hero{grid-template-columns:1fr}.col-8{grid-column:span 12}.col-6{grid-column:span 12}.col-4{grid-column:span 12}}
  </style>

  <!-- Libraries -->
  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js" crossorigin="anonymous"></script>
</head>
<body>

<header class="header">
  <nav class="nav">
    <div class="brand">
      <span style="font-size:20px">ğŸ¬</span>
      <span>Visual AI Studio â€” EPIC v1.2.1</span>
    </div>
    <div class="actions">
      <input id="importFile" type="file" accept=".json,.zip" style="display:none"/>
      <button id="importBtn" class="btn">â¬†ï¸ Import Session</button>
      <button id="bundleBtn" class="btn">â¬‡ï¸ Export Bundle (.zip)</button>
      <button id="resetBtn" class="btn btn-danger">â™»ï¸ Reset All</button>
      <span id="saveIndicator" class="small">Unsaved</span>
      <span id="jsReady" class="small">JS: loadingâ€¦</span>
    </div>
  </nav>
</header>

<main class="wrap" data-save-scope>

  <!-- Hero / Overview -->
  <section class="hero">
    <div>
      <div class="pill">Text â†’ Clips â†’ Timeline â†’ Render</div>
      <h1 style="margin:8px 0 4px">Plan, Generate, Assemble &amp; Export Short-Form Video</h1>
      <p class="small" style="max-width:720px">
        Write a script, auto-generate a shot list, turn shots into scenes, attach assets, add captions, and export a shareable bundle.
        Includes safe-area overlays, watermark, and experimental MP4 render via FFmpeg.wasm (depending on browser support).
      </p>
    </div>
  </section>

  <!-- Tabs -->
  <section class="card" aria-label="steps">
    <div class="tabs" role="tablist" aria-label="Workflow steps">
      <button class="tab active" data-step="1" role="tab" aria-selected="true">1) Script</button>
      <button class="tab" data-step="2" role="tab" aria-selected="false">2) Shot List &amp; Prompts</button>
      <button class="tab" data-step="3" role="tab" aria-selected="false">3) Assets &amp; Timeline</button>
      <button class="tab" data-step="4" role="tab" aria-selected="false">4) Captions &amp; Branding</button>
      <button class="tab" data-step="5" role="tab" aria-selected="false">5) Preview &amp; Export</button>
    </div>
    <div class="progress" aria-hidden="true"><div></div></div>
  </section>

  <!-- Step 1 -->
  <section id="step1" class="card" aria-labelledby="tab1">
    <div class="grid">
      <div class="col-8">
        <label for="projectTitle">Project Title</label>
        <input id="projectTitle" placeholder="Your video title"/>
        <label for="script">Script</label>
        <textarea id="script" rows="10" placeholder="Write or paste your script here..."></textarea>

        <div class="toolbar" style="margin-top:8px">
          <button id="genShotlist" class="btn btn-primary">âœ¨ Generate Shot List</button>
          <button id="toS2" class="btn" disabled>Continue â†’ Shot List &amp; Prompts</button>
        </div>
      </div>
      <div class="col-4">
        <label for="tone">Tone</label>
        <select id="tone">
          <option>Friendly</option><option>Professional</option><option>Funny</option><option>Inspirational</option>
        </select>
        <label for="style">Style</label>
        <select id="style">
          <option>UGC / Talking Head</option><option>B-roll Montage</option><option>App/Screen Demo</option><option>Product Teaser</option>
        </select>
        <label for="targetLen">Target Length (sec)</label>
        <input id="targetLen" type="number" min="6" max="180" value="30"/>
        <label for="platform">Platform</label>
        <select id="platform">
          <option>Reels</option><option>TikTok</option><option>Shorts</option><option>Twitter/X</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Step 2 -->
  <section id="step2" class="card" hidden>
    <div class="grid">
      <div class="col-8">
        <label for="shotlist">Shot List / Prompts</label>
        <textarea id="shotlist" rows="12" placeholder="- 3s: Close-up of hands unboxingâ€¦&#10;- 4s: Over-shoulder screen captureâ€¦"></textarea>
        <div class="toolbar" style="margin-top:8px">
          <button id="addScene" class="btn">â• Add Scene from Highlight</button>
          <button id="fitEven" class="btn">â± Fit to Target (Even)</button>
          <button id="fitWords" class="btn">ğŸ“ Fit by Word Count</button>
          <button id="toS3" class="btn" disabled>Continue â†’ Assets &amp; Timeline</button>
        </div>
        <p class="small">Select text in the shot list and click â€œAdd Scene from Highlightâ€ to create scenes with prompts.</p>
      </div>
      <div class="col-4">
        <label for="aspect">Aspect Ratio</label>
        <select id="aspect">
          <option>9:16 vertical</option><option>1:1 square</option><option>16:9 horizontal</option>
        </select>
        <label for="promptFlavor">Prompt Flavor</label>
        <select id="promptFlavor">
          <option>Plain</option><option>Filmic</option><option>Hyper-real</option><option>Stylized</option>
        </select>
        <label for="safety">Safety</label>
        <select id="safety">
          <option>PG</option><option>PG-13</option><option>R</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Step 3 -->
  <section id="step3" class="card" hidden>
    <div class="grid">
      <div class="col-6">
        <div class="row">
          <input id="mediaInput" type="file" accept="image/*,video/*" multiple style="display:none"/>
          <button id="uploadMedia" class="btn btn-primary">ğŸ“ Upload Media</button>
          <button id="toS4" class="btn" disabled>Continue â†’ Captions &amp; Branding</button>
        </div>
        <div id="assetList" class="asset-list" style="margin-top:10px"></div>
      </div>
      <div class="col-6">
        <div class="row"><strong>Timeline</strong></div>
        <div id="timeline" class="timeline" style="margin-top:6px"></div>
      </div>
    </div>
  </section>

  <!-- Step 4 -->
  <section id="step4" class="card" hidden>
    <div class="grid">
      <div class="col-6">
        <label for="captions">Captions (one per line)</label>
        <textarea id="captions" rows="10" placeholder="0-2s: Hook line&#10;2-5s: Value point #1&#10;â€¦"></textarea>
        <label for="brandTopText">Brand Top Text</label>
        <input id="brandTopText" placeholder="e.g., @mikeguides.co"/>
        <label for="brandBottomText">Brand Bottom Text</label>
        <input id="brandBottomText" placeholder="URL or CTA"/>
        <div class="row">
          <label for="wmAlpha">Watermark Opacity</label>
          <input id="wmAlpha" type="range" min="0" max="1" step="0.05" value="0.8" style="width:200px"/>
        </div>
      </div>
      <div class="col-6">
        <div class="row kpi">
          <div class="pill">Scenes: <span id="kScenes">0</span></div>
          <div class="pill">Total sec: <span id="kTotal">0</span></div>
          <div class="pill">Target sec: <span id="paceTarget">0</span></div>
          <div class="pill">Delta: <span id="paceDelta">0</span></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="toS5" class="btn">Continue â†’ Preview &amp; Export</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Step 5 -->
  <section id="step5" class="card" hidden>
    <div class="grid">
      <div class="col-8">
        <canvas id="preview" width="720" height="1280"></canvas>
        <div class="toolbar" style="margin-top:8px">
          <button id="renderStill" class="btn">ğŸ–¼ Render Still</button>
          <button id="renderMP4" class="btn">ğŸ Experimental MP4</button>
          <button id="downloadAssets" class="btn">ğŸ“¦ Export Assets List</button>
        </div>
        <textarea id="renderLog" class="small" rows="8" placeholder="Render log will appear hereâ€¦"></textarea>
      </div>
      <div class="col-4">
        <div class="notice">
          <strong>Heads-up:</strong> MP4 rendering uses FFmpeg.wasm and is experimental. Some browsers may struggle with longer clips.
        </div>
        <label>Safe Area Guides</label>
        <div class="row">
          <label><input type="checkbox" id="safeTop" checked/> Top</label>
          <label><input type="checkbox" id="safeBottom" checked/> Bottom</label>
        </div>
      </div>
    </div>
  </section>

</main>

<script>
// ---------- helpers ----------
const $=(s,c=document)=>c.querySelector(s); const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const KEY='visual_ai_studio_epic_v1_2_1';
const now=()=>new Date().toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});
const log=(msg)=>{ const el=$('#renderLog'); if(el){ el.value += (el.value?'\n':'')+ msg; el.scrollTop=el.scrollHeight; } };
function download(filename, blobOrText, type){
  const blob = blobOrText instanceof Blob ? blobOrText : new Blob([blobOrText], {type: type||'text/plain'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}
function markSaved(){ const el=$('#saveIndicator'); if(el) el.textContent='Saved â€¢ '+now(); }
function markDirty(){ const el=$('#saveIndicator'); if(el && !el.textContent.startsWith('Saved')) el.textContent='Unsaved'; }
function sum(arr){ return arr.reduce((a,b)=>a+(+b||0),0); }
function wc(s){ return (s||'').trim().split(/\s+/).filter(Boolean).length; }

// ---------- state ----------
let step=1;
let scenes=[];
let assets=[];
let watermark={img:null, pos:'bottom-right', alpha:0.8};

// ---------- UI wiring ----------
function setStepEnabled(n, on){ const tabs=$$('.tabs .tab'); tabs.forEach((t,i)=>{ const active=i===step-1; t.classList.toggle('active',active); t.setAttribute('aria-selected',active?'true':'false'); }); }
function goto(n){
  step=n;
  $$('#step1,#step2,#step3,#step4,#step5').forEach((s,i)=>s.hidden=(i!==n-1));
  const tabs=$$('.tabs .tab'); tabs.forEach((t,i)=>{ const on=i===n-1; t.classList.toggle('active',on); t.setAttribute('aria-selected',on?'true':'false'); });
  $('.progress>div').style.width = (n-1)*25 + '%';
  setStepEnabled(n,true);
}
$$('.tabs .tab').forEach(btn=>{
  btn.addEventListener('click',()=>goto(Number(btn.dataset.step)));
});

// ---------- Step 1: Script ----------
$('#genShotlist').addEventListener('click', ()=>{
  const s=$('#script').value.trim();
  if(!s){ alert('Add a script first.'); return; }
  // simple heuristic breakdown by sentences
  const sentences = s.split(/(?<=[.?!])\s+/).filter(Boolean);
  const target = Number($('#targetLen').value||'30');
  const each = Math.max(2, Math.round(target/Math.max(3, sentences.length)));
  const list = sentences.map((line,i)=>`- ${each}s: ${line}`).join('\n');
  $('#shotlist').value = list;
  markSaved();
  $('#toS2').disabled = false;
});

$('#toS2').addEventListener('click', ()=>goto(2));

// ---------- Step 2: Shot list & prompts ----------
function setStepEnabled2(){
  const sl=$('#shotlist');
  if(sl){ sl.addEventListener('input', ()=>{ const ok=!!sl.value.trim(); setStepEnabled(2, ok); }); }
  // Live gating: if Shotlist has content, enable Step 2
  const ok=!!$('#shotlist').value.trim();
  setStepEnabled(2,ok);
}
setStepEnabled2();

function basePromptFrom(text){
  const tone=$('#tone').value;
  const style=$('#style').value;
  const aspect=$('#aspect').value;
  const flavor=$('#promptFlavor').value;
  return `Create a ${aspect} ${style} video shot: ${text}. Tone: ${tone}. Prompt style: ${flavor}.`;
}

$('#addScene').addEventListener('click', ()=>{
  const ta=$('#shotlist');
  const sel=ta.value.substring(ta.selectionStart, ta.selectionEnd).trim() || ta.value.split('\n')[0] || '';
  if(!sel){ alert('Highlight a line first.'); return; }
  const m=/^-\s*(\d+)s:\s*(.*)$/.exec(sel);
  const dur = m ? Number(m[1]) : 3;
  const prompt = m ? m[2] : sel;
  addSceneRow(prompt, dur);
  $('#toS3').disabled = scenes.length===0;
  markSaved();
});

$('#fitEven').addEventListener('click', ()=>fitToTarget('even'));
$('#fitWords').addEventListener('click', ()=>fitToTarget('words'));
$('#toS3').addEventListener('click', ()=>goto(3));

// ---------- Step 3: assets & timeline ----------
function renderAssets(){
  const list=$('#assetList'); list.innerHTML='';
  assets.forEach(a=>{
    const div=document.createElement('div'); div.className='asset';
    div.innerHTML=`<div class="small" style="opacity:.8">${a.type.toUpperCase()} â€¢ ${a.name}</div>
      <video ${a.type==='video'?'':'style="display:none"'} src="${a.url}" muted playsinline width="100%"></video>
      <img ${a.type==='image'?'':'style="display:none"'} src="${a.url}" style="width:100%;border-radius:8px;opacity:.9"/>
      <div class="toolbar" style="margin-top:6px">
        <button class="btn" data-add>â• Add to Timeline</button>
        <button class="btn" data-rm>ğŸ—‘ Remove</button>
      </div>`;
    div.querySelector('[data-add]').addEventListener('click',()=>{
      const clip={id:String(Date.now()+Math.random()),assetId:a.id,start:0,duration:3};
      addClipToTimeline(clip);
      markSaved();
    });
    div.querySelector('[data-rm]').addEventListener('click',()=>{
      assets=assets.filter(x=>x.id!==a.id); scenes.forEach(s=>{ if(s.assetId===a.id) s.assetId=null; });
      renderAssets(); renderScenes(); renderTimeline(); markSaved();
    });
    list.appendChild(div);
  });
}

function sceneCard(scene){
  const div=document.createElement('div'); div.className='clip';
  div.innerHTML = `<div class="small"><strong>Scene</strong></div>
    <div style="font-weight:600;margin:4px 0">${scene.prompt||'(no prompt)'}</div>
    <div class="small">Duration: <input type="number" min="1" max="20" value="${scene.duration||3}" style="width:76px" data-dur/></div>
    <div class="small">Movement: 
      <select data-move>
        <option${scene.movement==='Static'?' selected':''}>Static</option>
        <option${scene.movement==='Pan'?' selected':''}>Pan</option>
        <option${scene.movement==='Dolly'?' selected':''}>Dolly</option>
        <option${scene.movement==='Tilt'?' selected':''}>Tilt</option>
        <option${scene.movement==='Zoom'?' selected':''}>Zoom</option>
      </select>
    </div>
    <div class="toolbar" style="margin-top:6px">
      <button class="btn ho-runway">ğŸª„ Copy Prompt (Runway)</button>
      <button class="btn ho-pika">ğŸª„ Copy Prompt (Pika)</button>
      <button class="btn ho-luma">ğŸª„ Copy Prompt (Luma)</button>
      <button class="btn ho-svd">ğŸª„ Copy Prompt (SVD)</button>
      <button class="btn" data-attach>ğŸ“ Attach Asset</button>
      <button class="btn" data-remove>ğŸ—‘ Remove</button>
    </div>`;
  const base=(tool)=>`Create a ${$('#aspect').value} ${scene.movement||'Static'} shot depicting: ${scene.prompt||'(describe scene)'} in the style ${$('#promptFlavor').value}. Tool: ${tool}.`;
  div.querySelector('.ho-runway').addEventListener('click',()=>navigator.clipboard.writeText(base('Runway')+` (Runway: Motion Brush Off, Seed locked for consistency)`));
  div.querySelector('.ho-pika').addEventListener('click',()=>navigator.clipboard.writeText(base('Pika')+` (Pika: v1/v2; add "camera ${scene.movement||'static'}")`));
  div.querySelector('.ho-luma').addEventListener('click',()=>navigator.clipboard.writeText(base('luma')+` (Luma: High fidelity, strong adherence)`));
  div.querySelector('.ho-svd').addEventListener('click',()=>navigator.clipboard.writeText(base('svd')+` (Stable Video Diffusion; steps 30, guidance 7)`));
  div.querySelector('[data-attach]').addEventListener('click',()=>{
    const name=prompt('Attach asset by name (matches uploaded asset name exactly).'); if(!name) return;
    const asset=assets.find(a=>a.name===name);
    if(!asset){ alert('No asset found with that name.'); return; }
    scene.assetId=asset.id; renderScenes(); renderTimeline(); markSaved();
  });
  div.querySelector('[data-remove]').addEventListener('click',()=>{
    scenes=scenes.filter(s=>s!==scene); renderScenes(); renderTimeline(); updatePaceInfo(); markSaved();
  });
  div.querySelector('[data-dur]').addEventListener('change',(e)=>{
    scene.duration = Math.max(1, Number(e.target.value||3)); updatePaceInfo(); renderTimeline(); markSaved();
  });
  div.querySelector('[data-move]').addEventListener('change',(e)=>{
    scene.movement = e.target.value; markSaved();
  });
  return div;
}
function renderScenes(){
  const wrap=$('#sceneContainer'); if(!wrap){ const c=document.createElement('div'); c.id='sceneContainer'; c.className='asset-list'; $('#step3 .grid .col-6').appendChild(c); }
  const scWrap=$('#sceneContainer'); scWrap.innerHTML='';
  scenes.forEach(s=>scWrap.appendChild(sceneCard(s)));
  $('#toS3').disabled = scenes.length===0;
  updatePaceInfo();
}
function addSceneRow(text='', dGuess=3){
  const sc={id:String(Date.now()+Math.random()),prompt:text,duration:dGuess,movement:'Static',notes:'',assetId:null};
  scenes.push(sc); renderScenes(); markSaved();
}

function updatePaceInfo(){
  const target = Number($('#targetLen').value||'0');
  const total = sum(scenes.map(s=>Number(s.duration)||0));
  $('#paceTarget').textContent = target;
  $('#paceCurrent').textContent = total;
  $('#paceDelta').textContent = (total-target);
}
function fitToTarget(mode='even'){
  const target = Math.max(1, Number($('#targetLen').value||'12'));
  if(!scenes.length){ alert('Add scenes first.'); return; }
  let weights = scenes.map(s=>1);
  if(mode==='words'){
    weights = scenes.map(s=>Math.max(1, wc(s.prompt||'')));
  }
  const sumW = weights.reduce((a,b)=>a+b,0);
  scenes.forEach((s,i)=>{ s.duration = Math.max(1, Math.round(target * (weights[i]/sumW))); });
  renderScenes(); updatePaceInfo(); markSaved();
}

// Uploads & Timeline
$('#uploadMedia').addEventListener('click',()=>$('#mediaInput').click());
$('#mediaInput').addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files||[]);
  for(const f of files){
    const url = URL.createObjectURL(f);
    const type = f.type.startsWith('video') ? 'video' : 'image';
    const a={id:String(Date.now()+Math.random()), name:f.name, url, type};
    assets.push(a);
  }
  renderAssets(); markSaved();
  $('#toS4').disabled = scenes.every(s=>!s.assetId);
});

// Timeline (simple list of scene thumbnails)
function renderTimeline(){
  const t=$('#timeline'); if(!t) return; t.innerHTML='';
  scenes.forEach((s,i)=>{
    const asset = s.assetId ? assets.find(a=>a.id===s.assetId) : null;
    const div=document.createElement('div'); div.className='clip';
    div.innerHTML = `<div class="small"><strong>S${i+1}</strong></div>
      <div>${(asset?asset.name:'(no asset)')}</div>
      <div class="small" style="margin-top:4px"><strong>${s.movement}</strong> â€¢ ${s.duration||3}s ${asset?('â€¢ '+asset.type):''}</div>`;
    t.appendChild(div);
  });
}
function addClipToTimeline(clip){ /* placeholder for future timeline data structure */ renderTimeline(); }

// ---------- Step 4: branding ----------
$('#toS4').addEventListener('click', ()=>goto(4));

// ---------- Step 5 ----------
$('#toS5').addEventListener('click', ()=>goto(5));

// Rendering preview (still) & MP4 (experimental)
async function loadFFmpeg(){
  if(window._ffm) return window._ffm;
  try{
    const { createFFmpeg } = FFmpeg; // from @ffmpeg/ffmpeg
    const ff = createFFmpeg({ log: true });
    await ff.load();
    window._ffm = ff;
    return ff;
  }catch(err){
    alert('FFmpeg failed to load: '+(err.message||String(err)));
    throw err;
  }
}
$('#renderStill').addEventListener('click', ()=>{
  const c=$('#preview'); const ctx=c.getContext('2d'); ctx.fillStyle='#000'; ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle='#fff'; ctx.font='bold 32px Inter, sans-serif'; ctx.fillText($('#projectTitle').value||'Preview', 20, 60);
  ctx.font='16px Inter, sans-serif'; ctx.fillText('Scenes: '+scenes.length, 20, 100);
  markSaved(); log('Rendered still preview.');
});

$('#renderMP4').addEventListener('click', async ()=>{
  log('Loading FFmpegâ€¦');
  const ff = await loadFFmpeg().catch(()=>null);
  if(!ff){ log('FFmpeg not available.'); return; }
  log('FFmpeg loaded. (This is a stub â€” implement actual frames later.)');
  alert('Experimental stub: MP4 export not fully implemented yet.');
});

$('#downloadAssets').addEventListener('click', ()=>{
  const list = assets.map(a=>`${a.type.toUpperCase()} ${a.name} â€” ${a.url}`).join('\n');
  download('assets.txt', list, 'text/plain');
});

// Import / Export / Reset
$('#importBtn').addEventListener('click', ()=>$('#importFile').click());
$('#importFile').addEventListener('change', async (e)=>{
  try{
    const f=e.target.files[0]; if(!f) return;
    const txt=await f.text();
    const data=JSON.parse(txt);
    restoreFrom(data);
    alert('Import complete');
  } catch(err){
    alert('Import failed: '+(err.message||String(err)));
  } finally { e.target.value=''; }
});
$('#bundleBtn').addEventListener('click', bundleZip);
$('#resetBtn').addEventListener('click', ()=>{ if(confirm('Reset your current session?')){ localStorage.removeItem(KEY); location.reload(); } });

function bundleZip(){
  if(typeof JSZip==='undefined'){ alert('JSZip missing.'); return; }
  const zip=new JSZip();
  zip.file('session.json', JSON.stringify(collectState(),null,2));
  const md = [
    '# Visual AI Studio Project: '+($('#projectTitle').value||'Untitled'),
    '',
    '## Script', $('#script').value||'',
    '',
    '## Shot List', $('#shotlist').value||'',
    '',
    '## Scenes',
    ...scenes.map((s,i)=>`- S${i+1}: ${s.duration||3}s, ${s.movement||'Static'} â€” ${(s.prompt||'')}`),
    '',
    '## Captions', $('#captions').value||'',
    '',
    'Generated '+new Date().toLocaleString()
  ].join('\n');
  zip.file('project.md', md);
  zip.file('assets.txt', assets.map(a=>`${a.type.toUpperCase()} ${a.name} â€” ${a.url}`).join('\n'));
  zip.generateAsync({type:'blob'}).then(blob=>download('visual-ai-studio-bundle.zip', blob));
}

// autosave
function collectState(){
  return {
    title: $('#projectTitle').value||'',
    script: $('#script').value||'',
    shotlist: $('#shotlist').value||'',
    target: Number($('#targetLen').value||'0'),
    tone: $('#tone').value, style: $('#style').value, platform: $('#platform').value,
    aspect: $('#aspect').value, flavor: $('#promptFlavor').value, safety: $('#safety').value,
    scenes, assets,
    captions: $('#captions').value||'',
    brandTop: $('#brandTopText').value||'',
    brandBottom: $('#brandBottomText').value||'',
    wmAlpha: Number($('#wmAlpha').value||'0.8'),
  };
}
function restoreFrom(data){
  try{
    $('#projectTitle').value=data.title||'';
    $('#script').value=data.script||'';
    $('#shotlist').value=data.shotlist||'';
    $('#targetLen').value=data.target||'30';
    $('#tone').value=data.tone||'Friendly';
    $('#style').value=data.style||'UGC / Talking Head';
    $('#platform').value=data.platform||'Reels';
    $('#aspect').value=data.aspect||'9:16 vertical';
    $('#promptFlavor').value=data.flavor||'Plain';
    $('#safety').value=data.safety||'PG';
    scenes = Array.isArray(data.scenes)? data.scenes : [];
    assets = Array.isArray(data.assets)? data.assets : [];
    $('#captions').value=data.captions||'';
    $('#brandTopText').value=data.brandTop||'';
    $('#brandBottomText').value=data.brandBottom||'';
    $('#wmAlpha').value=data.wmAlpha||0.8;
    renderAssets(); renderScenes(); renderTimeline(); updatePaceInfo();
    markSaved();
  } catch(e){ console.warn(e); markDirty(); }
}
function autosaveWire(){
  $$('.wrap input, .wrap textarea, .wrap select').forEach(el=>{
    ['input','change','keyup','blur'].forEach(evt=>el.addEventListener(evt, ()=>{
      localStorage.setItem(KEY, JSON.stringify(collectState())); markSaved();
    }));
  });
  const sl=$('#shotlist');
  if(sl){ sl.addEventListener('input', ()=>{ const ok=!!sl.value.trim(); setStepEnabled(2, ok); }); }
}

// init
function renderOnLoad(){
  renderAssets(); renderScenes(); renderTimeline(); updatePaceInfo();
  if($('#shotlist').value.trim()) setStepEnabled(2,true);
  if(scenes.length) setStepEnabled(3,true);
  if($('#captions').value.trim() || $('#brandTopText').value.trim() || $('#brandBottomText').value.trim()) setStepEnabled(4,true);
  if($('#captions').value.trim() || $('#brandTopText').value.trim() || $('#brandBottomText').value.trim()) setStepEnabled(5,true);
}
function init(){
  $('#jsReady').textContent='JS: ready';
  autosaveWire(); restore(); renderOnLoad();
}
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
</script>
</body>
</html>
